---
- name: Require exactly one host in the gighive group for single-VM autostart
  ansible.builtin.assert:
    that:
      - (groups['gighive'] | default([])) | length == 1
    fail_msg: >-
      Single-VM autostart expects exactly one inventory host in the 'gighive' group.

- name: Capture the single gighive inventory host
  ansible.builtin.set_fact:
    gighive_inventory_host: "{{ (groups['gighive'] | default([]) | first) }}"

- name: Require enable_vbox_vm_autostart is enabled for gighive
  ansible.builtin.assert:
    that:
      - (hostvars[gighive_inventory_host].enable_vbox_vm_autostart | default(false)) | bool
    fail_msg: >-
      enable_vbox_vm_autostart is not enabled for the gighive VM.
      Set enable_vbox_vm_autostart: true in ansible/inventories/group_vars/gighive/gighive.yml

- name: Derive vbox_autostart_vm_name from gighive vm_name
  ansible.builtin.set_fact:
    vbox_autostart_vm_name: "{{ hostvars[gighive_inventory_host].vm_name }}"

- name: Require vm_name is set for gighive
  ansible.builtin.assert:
    that:
      - (vbox_autostart_vm_name | default('') | trim) | length > 0
    fail_msg: >-
      vm_name is not set for the gighive VM.

- name: Derive vbox_autostart_user from controller login environment
  ansible.builtin.set_fact:
    vbox_autostart_user: >-
      {{
        (lookup('env', 'SUDO_USER') | default('') | trim)
          if (lookup('env', 'SUDO_USER') | default('') | trim) | length > 0
          else (lookup('env', 'USER') | default('') | trim)
      }}

- name: Fallback to id -un for vbox_autostart_user if env not set
  ansible.builtin.command: id -un
  register: vbox_autostart_user_id
  changed_when: false
  become: false
  when: (vbox_autostart_user | default('') | trim) | length == 0

- name: Set vbox_autostart_user from id -un fallback
  ansible.builtin.set_fact:
    vbox_autostart_user: "{{ vbox_autostart_user_id.stdout | trim }}"
  when:
    - (vbox_autostart_user | default('') | trim) | length == 0
    - vbox_autostart_user_id is defined
    - (vbox_autostart_user_id.stdout | default('') | trim) | length > 0

- name: Lookup autostart user passwd entry
  ansible.builtin.command: "getent passwd {{ vbox_autostart_user }}"
  register: vbox_autostart_passwd
  changed_when: false

- name: Derive autostart user uid and home
  ansible.builtin.set_fact:
    vbox_autostart_uid: "{{ (vbox_autostart_passwd.stdout.split(':')[2] | default('')) }}"
    vbox_autostart_home: "{{ (vbox_autostart_passwd.stdout.split(':')[5] | default('')) }}"

- name: Require autostart user uid and home are resolvable
  ansible.builtin.assert:
    that:
      - (vbox_autostart_uid | default('') | trim) | length > 0
      - (vbox_autostart_home | default('') | trim) | length > 0
    fail_msg: "Could not resolve uid/home for vbox_autostart_user={{ vbox_autostart_user }} via getent passwd"

- name: Debug autostart derived values
  ansible.builtin.debug:
    msg:
      - "gighive_inventory_host={{ gighive_inventory_host }}"
      - "vbox_autostart_vm_name={{ vbox_autostart_vm_name }}"
      - "vbox_autostart_user={{ vbox_autostart_user }}"
      - "vbox_autostart_uid={{ vbox_autostart_uid }}"
      - "vbox_autostart_home={{ vbox_autostart_home }}"

- name: Debug VirtualBox CLI availability (as autostart user)
  ansible.builtin.command: /usr/bin/VBoxManage --version
  become: true
  become_user: "{{ vbox_autostart_user }}"
  changed_when: false
  register: vboxmanage_version_debug

- name: Debug VBoxManage version output
  ansible.builtin.debug:
    var: vboxmanage_version_debug.stdout

- name: Debug autostart user environment (HOME, XDG_RUNTIME_DIR)
  ansible.builtin.shell: |
    set -e
    echo "USER=$(id -un)"
    echo "HOME=$HOME"
    echo "XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-}"
    ls -ld "$HOME" || true
    ls -ld "${XDG_RUNTIME_DIR:-/run/user/NO_XDG}" || true
  become: true
  become_user: "{{ vbox_autostart_user }}"
  changed_when: false
  register: autostart_user_env_debug

- name: Debug autostart user environment output
  ansible.builtin.debug:
    var: autostart_user_env_debug.stdout_lines

- name: Debug VBoxManage list vms (as autostart user)
  ansible.builtin.command: /usr/bin/VBoxManage list vms
  become: true
  become_user: "{{ vbox_autostart_user }}"
  changed_when: false
  failed_when: false
  register: vbox_list_vms_debug

- name: Debug VBoxManage list vms output
  ansible.builtin.debug:
    var: vbox_list_vms_debug.stdout_lines

- name: Debug VBoxManage list runningvms (as autostart user)
  ansible.builtin.command: /usr/bin/VBoxManage list runningvms
  become: true
  become_user: "{{ vbox_autostart_user }}"
  changed_when: false
  failed_when: false
  register: vbox_list_runningvms_debug

- name: Debug VBoxManage list runningvms output
  ansible.builtin.debug:
    var: vbox_list_runningvms_debug.stdout_lines

- name: Install and enable VM autostart systemd units
  block:
    - name: Install gighive-vbox-autostart@.service template
      ansible.builtin.copy:
        dest: /etc/systemd/system/gighive-vbox-autostart@.service
        owner: root
        group: root
        mode: "0644"
        content: |
          [Unit]
          Description=GigHive VirtualBox VM autostart (%i)
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=oneshot
          User={{ vbox_autostart_user }}
          Environment=HOME={{ vbox_autostart_home }}
          Environment=XDG_RUNTIME_DIR=/run/user/{{ vbox_autostart_uid }}
          Environment=VBOX_USER_HOME={{ vbox_autostart_home }}/.config/VirtualBox
          WorkingDirectory={{ vbox_autostart_home }}
          ExecStart=/bin/bash -c '/usr/bin/VBoxManage list runningvms | grep -Fq "\"%i\"" || /usr/bin/VBoxManage startvm "%i" --type headless'
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Enable and start autostart units for enabled VMs
      ansible.builtin.systemd:
        name: "gighive-vbox-autostart@{{ vbox_autostart_vm_name }}.service"
        enabled: true
        state: stopped

    - name: Attempt to start autostart unit (non-fatal)
      ansible.builtin.systemd:
        name: "gighive-vbox-autostart@{{ vbox_autostart_vm_name }}.service"
        state: started
      register: vbox_autostart_unit_start
      failed_when: false

    - name: Debug unit start result
      ansible.builtin.debug:
        var: vbox_autostart_unit_start

    - name: Debug systemctl status for autostart unit
      ansible.builtin.command: "systemctl status gighive-vbox-autostart@{{ vbox_autostart_vm_name }}.service --no-pager"
      changed_when: false
      failed_when: false
      register: vbox_autostart_unit_status

    - name: Print systemctl status
      ansible.builtin.debug:
        var: vbox_autostart_unit_status.stdout_lines

    - name: Debug journalctl for autostart unit
      ansible.builtin.command: "journalctl -xeu gighive-vbox-autostart@{{ vbox_autostart_vm_name }}.service --no-pager -n 200"
      changed_when: false
      failed_when: false
      register: vbox_autostart_unit_journal

    - name: Print journalctl
      ansible.builtin.debug:
        var: vbox_autostart_unit_journal.stdout_lines

