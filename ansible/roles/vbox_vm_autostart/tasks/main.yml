---
- name: Require exactly one host in the gighive group for single-VM autostart
  ansible.builtin.assert:
    that:
      - (groups['gighive'] | default([])) | length == 1
    fail_msg: >-
      Single-VM autostart expects exactly one inventory host in the 'gighive' group.

- name: Capture the single gighive inventory host
  ansible.builtin.set_fact:
    gighive_inventory_host: "{{ (groups['gighive'] | default([]) | first) }}"

- name: Require enable_vbox_vm_autostart is enabled for gighive
  ansible.builtin.assert:
    that:
      - (hostvars[gighive_inventory_host].enable_vbox_vm_autostart | default(false)) | bool
    fail_msg: >-
      enable_vbox_vm_autostart is not enabled for the gighive VM.
      Set enable_vbox_vm_autostart: true in ansible/inventories/group_vars/gighive/gighive.yml

- name: Derive vbox_autostart_vm_name from gighive vm_name
  ansible.builtin.set_fact:
    vbox_autostart_vm_name: "{{ hostvars[gighive_inventory_host].vm_name }}"

- name: Require vm_name is set for gighive
  ansible.builtin.assert:
    that:
      - (vbox_autostart_vm_name | default('') | trim) | length > 0
    fail_msg: >-
      vm_name is not set for the gighive VM.

- name: Derive vbox_autostart_user from controller login environment
  ansible.builtin.set_fact:
    vbox_autostart_user: >-
      {{
        (lookup('env', 'SUDO_USER') | default('') | trim)
          if (lookup('env', 'SUDO_USER') | default('') | trim) | length > 0
          else (lookup('env', 'USER') | default('') | trim)
      }}

- name: Fallback to id -un for vbox_autostart_user if env not set
  ansible.builtin.command: id -un
  register: vbox_autostart_user_id
  changed_when: false
  become: false
  when: (vbox_autostart_user | default('') | trim) | length == 0

- name: Set vbox_autostart_user from id -un fallback
  ansible.builtin.set_fact:
    vbox_autostart_user: "{{ vbox_autostart_user_id.stdout | trim }}"
  when:
    - (vbox_autostart_user | default('') | trim) | length == 0
    - vbox_autostart_user_id is defined
    - (vbox_autostart_user_id.stdout | default('') | trim) | length > 0

- name: Install and enable VM autostart systemd units
  block:
    - name: Install gighive-vbox-autostart@.service template
      ansible.builtin.copy:
        dest: /etc/systemd/system/gighive-vbox-autostart@.service
        owner: root
        group: root
        mode: "0644"
        content: |
          [Unit]
          Description=GigHive VirtualBox VM autostart (%i)
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=oneshot
          User={{ vbox_autostart_user }}
          Environment=HOME=%h
          Environment=VBOX_USER_HOME=%h/.config/VirtualBox
          ExecStart=/bin/bash -lc '/usr/bin/VBoxManage list runningvms | grep -Fq "\"%i\"" || /usr/bin/VBoxManage startvm "%i" --type headless'
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Enable and start autostart units for enabled VMs
      ansible.builtin.systemd:
        name: "gighive-vbox-autostart@{{ vbox_autostart_vm_name }}.service"
        enabled: true
        state: started

