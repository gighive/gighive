#cloud-config
# yamllint disable rule:line-length
---
package_update: true
packages:
  - cloud-guest-utils
  - e2fsprogs

growpart:
  mode: auto
  devices:
    - "/"
  ignore_growroot_disabled: false
resize_rootfs: true

hostname: gighive2
fqdn: gighive2.mysettings.com

users:
  - name: ubuntu
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    lock_passwd: false
    ssh_authorized_keys:
      - 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQChnSE4ESS4E03Ql5b+4QzNjTixOrVa8vVrCqvpa17uFZDYnnLYeqPsoJQjuEi4n567LeYC0vY+lnnwqy1RzVcXYIXmWdNmr7sVrU8Grs2Ax0Y3Xw7EWaahSjjbrsYbMFGeeD4WDHWjNdW8T7r98XKIbX6nTV+e858vJ9mn8YYRVtYLTHnLNLeGDluusQOFkQW/YOYzDPENvJc1HKSLR+lAinEjPvR7J2XxYZ5/hyGIJep4vePAXAen4SSn9Q7xcz3nmw2U+PFBmQZFnAKodP9JScKE2Oj4hh0lIP47VqAOvZRJ54FuTStLBpQt3mJiL73Iydu5m37NilVIWb3NfdPYhEI7AA8RzNW0QJEkX1r8PpNq0ks2ouK2+neNvMEtAoGbi9Zzij0cLotjWpM4D4tJbRt78xgItORFCybcXwVjr4UWIVw7F2XQBKFBr9WEpoYRpSALqnjRvCDt0W2BV1ORFFMe4gxxlU/8awQ23MZjT9KhH3kWaYjEh6+KArf0KDk= sodo@pop-os'

ssh_pwauth: true

chpasswd:
  expire: false
  list:
    - ubuntu:yoboiboi

write_files:
  - path: /etc/hosts
    permissions: "0644"
    content: |
      127.0.0.1 localhost
      192.168.1.254 gighive2.mysettings.com gighive2
    append: true

runcmd:
  - [ "usermod", "--shell", "/bin/bash", "ubuntu" ]
  - [ "hostnamectl", "set-hostname", "gighive2" ]
  - [ "growpart", "/dev/sda", "1" ]
  - [ "resize2fs", "/dev/sda1" ]
  - [ "systemctl", "enable", "--now", "ssh" ]
  - [ "sed", "-i", "s/^#\\?PasswordAuthentication.*/PasswordAuthentication no/", "/etc/ssh/sshd_config" ]
  - [ "sed", "-i", "s/^#\\?ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/", "/etc/ssh/sshd_config" ]
  - [ "sed", "-i", "s/^#\\?PermitRootLogin.*/PermitRootLogin no/", "/etc/ssh/sshd_config" ]
  - [ "systemctl", "restart", "ssh" ]

