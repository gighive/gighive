---
- name: Upload tests 5 - generate manifest JSON on control host
  ansible.builtin.include_tasks: generate_manifest.yml
  vars:
    upload_tests_manifest_source_roots: "{{ upload_test_manifest_source_roots_add }}"
    upload_tests_manifest_path: "/tmp/upload_test_manifest_add.json"

- name: Upload tests 5 - DB counts before
  ansible.builtin.include_tasks: query_db_counts.yml
  vars:
    upload_tests_db_counts_prefix: upload_tests_db_before

- name: Upload tests 5 - POST import_manifest_add_async.php
  ansible.builtin.uri:
    url: "{{ gighive_base_url }}/import_manifest_add_async.php"
    method: POST
    url_username: "{{ admin_user }}"
    url_password: "{{ gighive_admin_password }}"
    force_basic_auth: true
    validate_certs: false
    body_format: json
    body: "{{ lookup('ansible.builtin.file', '/tmp/upload_test_manifest_add.json') | from_json }}"
    status_code: [200, 202]
    return_content: true
  register: upload_tests_5_http
  delegate_to: localhost
  become: false

- name: Upload tests 5 - parse response JSON
  ansible.builtin.set_fact:
    upload_tests_5_resp: "{{ upload_tests_5_http.json }}"

- name: Upload tests 5 - assert job queued
  ansible.builtin.assert:
    that:
      - upload_tests_5_resp.success | bool
      - upload_tests_5_resp.job_id is defined

- name: Upload tests 5 - poll job until completion
  ansible.builtin.include_tasks: poll_manifest_job.yml
  vars:
    upload_tests_job_id: "{{ upload_tests_5_resp.job_id }}"

- name: Upload tests 5 - DB counts after
  ansible.builtin.include_tasks: query_db_counts.yml
  vars:
    upload_tests_db_counts_prefix: upload_tests_db_after

- name: Upload tests 5 - parse counts
  ansible.builtin.set_fact:
    upload_tests_files_before: "{{ upload_tests_db_before_files_count | int }}"
    upload_tests_files_after: "{{ upload_tests_db_after_files_count | int }}"

- name: Upload tests 5 - assert files did not decrease and did not increase by more than manifest items
  ansible.builtin.assert:
    that:
      - (upload_tests_files_after | int) >= (upload_tests_files_before | int)
      - ((upload_tests_files_after | int) - (upload_tests_files_before | int)) <= (upload_tests_manifest_item_count.stdout | int)

- name: Upload tests 5 - upload binaries by hash (step 2)
  ansible.builtin.include_tasks: run_upload_media_by_hash.yml
  vars:
    upload_tests_source_roots: "{{ upload_test_manifest_source_roots_add }}"
