---
- name: Upload tests 3B - select CSV fixtures
  ansible.builtin.set_fact:
    upload_tests_3b_sessions_csv: >-
      {{
        ((upload_tests_variant.app_flavor | default(app_flavor)) == 'gighive')
        | ternary(upload_tests_csv_dir ~ '/sessionsSmall.csv', upload_tests_csv_dir ~ '/sessionsLarge.csv')
      }}
    upload_tests_3b_session_files_csv: >-
      {{
        ((upload_tests_variant.app_flavor | default(app_flavor)) == 'gighive')
        | ternary(upload_tests_csv_dir ~ '/session_filesSmall.csv', upload_tests_csv_dir ~ '/session_filesLarge.csv')
      }}

- name: Upload tests 3B - count fixture rows (sessions)
  ansible.builtin.set_fact:
    upload_tests_expected_sessions_count: >-
      {{
        [
          0,
          (
            (
              lookup('ansible.builtin.file', upload_tests_3b_sessions_csv)
              .splitlines()
              | map('trim')
              | reject('equalto', '')
              | list
              | length
            ) - 1
          )
        ] | max
      }}

- name: Upload tests 3B - POST import_normalized.php
  ansible.builtin.command:
    argv:
      - curl
      - -sS
      - -k
      - -u
      - "{{ admin_user }}:{{ gighive_admin_password }}"
      - -F
      - "sessions_csv=@{{ upload_tests_3b_sessions_csv }}"
      - -F
      - "session_files_csv=@{{ upload_tests_3b_session_files_csv }}"
      - "{{ gighive_base_url }}/import_normalized.php"
  register: upload_tests_3b_http
  changed_when: false
  delegate_to: localhost
  become: false

- name: Upload tests 3B - parse response JSON
  ansible.builtin.set_fact:
    upload_tests_3b_resp: "{{ upload_tests_3b_http.stdout | from_json }}"

- name: Upload tests 3B - assert success
  ansible.builtin.assert:
    that:
      - upload_tests_3b_resp.success | bool

- name: Upload tests 3B - extract import job id
  ansible.builtin.include_tasks: extract_import_job_id.yml
  vars:
    upload_tests_resp: "{{ upload_tests_3b_resp }}"
    upload_tests_job_id_fact: upload_tests_3b_job_id

- name: Upload tests 3B - derive expected files count from job prepped CSV (in apache container)
  ansible.builtin.include_tasks: derive_expected_files_from_prepped_csv.yml
  vars:
    upload_tests_job_id: "{{ upload_tests_3b_job_id }}"
    upload_tests_prepped_files_diag_fact: upload_tests_3b_prepped_files_diag_json
    upload_tests_expected_files_fact: upload_tests_expected_files_count

- name: Upload tests 3B - debug derived expected counts
  ansible.builtin.debug:
    msg:
      job_id: "{{ upload_tests_3b_job_id }}"
      expected_sessions_count: "{{ upload_tests_expected_sessions_count }}"
      expected_files_count: "{{ upload_tests_expected_files_count }}"
      prepped_files_diag: "{{ upload_tests_3b_prepped_files_diag_json }}"

- name: Upload tests 3B - DB count assertions
  ansible.builtin.include_tasks: assert_db_invariants.yml
  vars:
    upload_tests_expect_sessions_count: "{{ upload_tests_expected_sessions_count }}"
    upload_tests_expect_files_count: "{{ upload_tests_expected_files_count }}"
