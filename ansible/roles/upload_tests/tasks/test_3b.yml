---
- name: Upload tests 3B - select CSV fixtures
  ansible.builtin.set_fact:
    upload_tests_3b_sessions_csv: >-
      {{
        ((upload_tests_variant.app_flavor | default(app_flavor)) == 'gighive')
        | ternary(upload_tests_csv_dir ~ '/sessionsSmall.csv', upload_tests_csv_dir ~ '/sessionsLarge.csv')
      }}
    upload_tests_3b_session_files_csv: >-
      {{
        ((upload_tests_variant.app_flavor | default(app_flavor)) == 'gighive')
        | ternary(upload_tests_csv_dir ~ '/session_filesSmall.csv', upload_tests_csv_dir ~ '/session_filesLarge.csv')
      }}

- name: Upload tests 3B - count fixture rows (sessions)
  ansible.builtin.set_fact:
    upload_tests_expected_sessions_count: >-
      {{
        [
          0,
          (
            (
              lookup('ansible.builtin.file', upload_tests_3b_sessions_csv)
              .splitlines()
              | map('trim')
              | reject('equalto', '')
              | list
              | length
            ) - 1
          )
        ] | max
      }}

- name: Upload tests 3B - POST import_normalized.php
  ansible.builtin.command:
    argv:
      - curl
      - -sS
      - -k
      - -u
      - "{{ admin_user }}:{{ gighive_admin_password }}"
      - -F
      - "sessions_csv=@{{ upload_tests_3b_sessions_csv }}"
      - -F
      - "session_files_csv=@{{ upload_tests_3b_session_files_csv }}"
      - "{{ gighive_base_url }}/import_normalized.php"
  register: upload_tests_3b_http
  changed_when: false
  delegate_to: localhost
  become: false

- name: Upload tests 3B - parse response JSON
  ansible.builtin.set_fact:
    upload_tests_3b_resp: "{{ upload_tests_3b_http.stdout | from_json }}"

- name: Upload tests 3B - assert success
  ansible.builtin.assert:
    that:
      - upload_tests_3b_resp.success | bool

- name: Upload tests 3B - extract import job id
  ansible.builtin.set_fact:
    upload_tests_3b_job_id: >-
      {{
        (
          (upload_tests_3b_resp.steps[0].message | default('', true))
          | regex_findall('[0-9]{8}-[0-9]{6}-[0-9a-f]{12}')
          | first
        )
        | default('', true)
      }}

- name: Upload tests 3B - debug step message (job id extraction)
  ansible.builtin.debug:
    msg:
      step0_message: "{{ upload_tests_3b_resp.steps[0].message | default('', true) }}"
      extracted_job_id: "{{ upload_tests_3b_job_id }}"
  when: (upload_tests_3b_job_id | default('')) == ''

- name: Upload tests 3B - assert job id extracted
  ansible.builtin.assert:
    that:
      - (upload_tests_3b_job_id | default('')) != ''

- name: Upload tests 3B - derive expected files count from job prepped CSV (in apache container)
  community.docker.docker_container_exec:
    container: "{{ apache_container_name }}"
    command: >-
      python3 -c
      "import csv,json; p='/var/www/private/import_jobs/{{ upload_tests_3b_job_id }}/prepped_csvs/files.csv';
      r=csv.DictReader(open(p, newline='', encoding='utf-8'));
      fieldnames=list(r.fieldnames or []);
      rows=list(r);
      chk_col=('checksum_sha256' if 'checksum_sha256' in fieldnames else ('checksum' if 'checksum' in fieldnames else next((c for c in fieldnames if 'checksum' in (c or '').lower() or 'sha' in (c or '').lower()), '')));
      chks=[(((row.get(chk_col) if chk_col else '') or '').strip().lower()) for row in rows];
      empty=sum(1 for c in chks if c=='');
      uniq=len(set(c for c in chks if c!=''));
      out={'path':p,'fieldnames':fieldnames,'checksum_column':chk_col,'total_rows':len(rows),'empty_checksum_rows':empty,'unique_nonempty_checksums':uniq,'expected_loaded_rows':empty+uniq};
      print(json.dumps(out))"
  register: upload_tests_3b_prepped_files_diag
  changed_when: false

- name: Upload tests 3B - set expected files count
  ansible.builtin.set_fact:
    upload_tests_3b_prepped_files_diag_json: "{{ upload_tests_3b_prepped_files_diag.stdout | from_json }}"
    upload_tests_expected_files_count: "{{ (upload_tests_3b_prepped_files_diag.stdout | from_json).expected_loaded_rows | int }}"

- name: Upload tests 3B - debug derived expected counts
  ansible.builtin.debug:
    msg:
      job_id: "{{ upload_tests_3b_job_id }}"
      expected_sessions_count: "{{ upload_tests_expected_sessions_count }}"
      expected_files_count: "{{ upload_tests_expected_files_count }}"
      prepped_files_diag: "{{ upload_tests_3b_prepped_files_diag_json }}"

- name: Upload tests 3B - DB count assertions
  ansible.builtin.include_tasks: assert_db_invariants.yml
  vars:
    upload_tests_expect_sessions_count: "{{ upload_tests_expected_sessions_count }}"
    upload_tests_expect_files_count: "{{ upload_tests_expected_files_count }}"
