---
- name: Upload tests 4 - generate manifest JSON on control host
  ansible.builtin.include_tasks: generate_manifest.yml
  vars:
    upload_tests_manifest_source_roots: "{{ upload_test_manifest_source_roots_reload }}"
    upload_tests_manifest_path: "/tmp/upload_test_manifest_reload.json"

- name: Upload tests 4 - capture DB counts before
  community.docker.docker_container_exec:
    container: "{{ mysql_container_name | default(mysql_db_host) }}"
    env:
      MYSQL_PWD: "{{ mysql_appuser_password }}"
    command: >-
      mysql -N -B --show-warnings
      -u {{ mysql_user }}
      {{ mysql_database }}
      -e "SELECT (SELECT COUNT(*) FROM sessions) AS sessions_count, (SELECT COUNT(*) FROM files) AS files_count;"
  register: upload_tests_db_counts_before
  changed_when: false

- name: Upload tests 4 - POST import_manifest_reload_async.php
  ansible.builtin.uri:
    url: "{{ gighive_base_url }}/import_manifest_reload_async.php"
    method: POST
    url_username: "{{ admin_user }}"
    url_password: "{{ gighive_admin_password }}"
    force_basic_auth: true
    validate_certs: false
    body_format: json
    body: "{{ lookup('ansible.builtin.file', '/tmp/upload_test_manifest_reload.json') | from_json }}"
    status_code: [200, 202]
    return_content: true
  register: upload_tests_4_http
  delegate_to: localhost
  become: false

- name: Upload tests 4 - parse response JSON
  ansible.builtin.set_fact:
    upload_tests_4_resp: "{{ upload_tests_4_http.json }}"

- name: Upload tests 4 - assert job queued
  ansible.builtin.assert:
    that:
      - upload_tests_4_resp.success | bool
      - upload_tests_4_resp.job_id is defined

- name: Upload tests 4 - poll job until completion
  ansible.builtin.include_tasks: poll_manifest_job.yml
  vars:
    upload_tests_job_id: "{{ upload_tests_4_resp.job_id }}"

- name: Upload tests 4 - DB count assertions (reload)
  ansible.builtin.include_tasks: assert_db_invariants.yml
  vars:
    upload_tests_expect_sessions_count: null
    upload_tests_expect_files_count: "{{ upload_tests_manifest_item_count.stdout | int }}"

- name: Upload tests 4 - upload binaries by hash (step 2)
  ansible.builtin.include_tasks: run_upload_media_by_hash.yml
  vars:
    upload_tests_source_roots: "{{ upload_test_manifest_source_roots_reload }}"
