# --- ModSecurity base ---
#SecRuleEngine DetectionOnly
SecRuleEngine {{ modsec_enable | default(false) | bool | ternary('On','DetectionOnly') }}
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecStatusEngine Off
SecTmpDir /var/cache/modsecurity
SecDataDir /var/cache/modsecurity

# Reasonable limits (tuned higher for large media uploads)
# 6GB body limit to accommodate large video files
SecRequestBodyLimit 6442450944
SecRequestBodyNoFilesLimit 6442450944
SecRequestBodyInMemoryLimit 1048576
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# Prevent evasion via UTF-8 or weird encodings
SecUnicodeMapFile /etc/modsecurity/unicode.mapping
SecDefaultAction "phase:1,log,pass"
SecDefaultAction "phase:2,log,pass"

# Audit log (only on relevant events)
SecAuditEngine RelevantOnly
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/apache2/modsec_audit.log
SecAuditLogRelevantStatus "^(?:5|4(?!04))"

# Allow large bodies on API upload endpoint explicitly
<LocationMatch "^/api/uploads\.php$">
    SecRuleEngine On
    SecRequestBodyAccess On
    SecRequestBodyLimit 6442450944
    # Require multipart for uploads
    SecRule REQUEST_HEADERS:Content-Type "!@beginsWith multipart/form-data" \
        "id:1201,phase:2,deny,status:415,msg:'Uploads must be multipart/form-data'"
    # Disallow dangerous extensions by filename as a safety net
    SecRule FILES_NAMES "\.(php\d?|phtml|phar|cgi|pl|asp|aspx|jsp|jar|exe|sh|bat|cmd|com|msi)$" \
        "id:1203,phase:2,deny,status:400,msg:'Disallowed extension for upload'"
</LocationMatch>
