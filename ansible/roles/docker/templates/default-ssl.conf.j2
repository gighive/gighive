# ------------------------------------------------------
# Security headers (requires mod_headers)
# ------------------------------------------------------
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    {% if gighive_hsts_enabled | default(false) %}
    Header always set Strict-Transport-Security "{{ gighive_hsts_value | default('max-age=31536000; includeSubDomains; preload') }}"
    {% endif %}
</IfModule>

# Never serve cache/logs over HTTP
<Directory "/var/www/html/var/cache">
    Require all denied
</Directory>

<VirtualHost *:443>
    ServerName {{ gighive_server_name }}
    ServerAlias {{ gighive_server_alias }}
    {% if gighive_server_name != gighive_host %}
    ServerAlias {{ gighive_host }}
    {% endif %}
    DocumentRoot /var/www/html
    DirectoryIndex index.php

    SSLEngine on
    SSLCertificateFile {{ gighive_ssl_cert_file | default('/etc/ssl/certs/origin_cert.pem') }}
    SSLCertificateKeyFile {{ gighive_ssl_key_file | default('/etc/ssl/private/origin_key.pem') }}
    SSLProtocol {{ gighive_ssl_protocols | default('all -SSLv3 -TLSv1 -TLSv1.1 +TLSv1.3') }}
    SSLCipherSuite {{ gighive_ssl_cipher_suite | default('HIGH:!aNULL:!MD5') }}
    SSLHonorCipherOrder {{ gighive_ssl_honor_order | default('on') }}
    Protocols {{ gighive_protocols | default('h2 http/1.1') }}

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    # -------------------------------
    # API routing - Using MVC architecture in /src/
    # -------------------------------

    RewriteEngine On

    # Route MVC API endpoints to the front controller.
    # Keep legacy script endpoint /api/uploads.php intact.
    RewriteCond %{REQUEST_URI} ^/api/uploads(?:/.*)?$
    RewriteCond %{REQUEST_URI} !^/api/uploads\.php$
    RewriteRule .* /src/index.php [QSA,L]

    RewriteCond %{REQUEST_URI} ^/api/media-files$
    RewriteRule .* /src/index.php [QSA,L]

    # -------------------------------
    # Root is public, but no indexes
    # -------------------------------
    <Directory "/var/www/html">
        AllowOverride None
        Options -Indexes +FollowSymLinks
        Require all granted
    </Directory>

    # ------------------------------------------------------
    # Protect non-root application paths with Basic Auth
    # ------------------------------------------------------
    # Deny cache outright (no auth challenge)
    <LocationMatch "^/app/cache(/|$)">
        Require all denied
    </LocationMatch>
    
    # --- PUBLIC HOMEPAGE ---
    # (No auth block here, so / and /index.php stay open)
    
    # Request-time staging-only public exception for /db/database.php
    <Location "/db/database.php">
        <If "%{HTTP_HOST} == 'staging.gighive.app'">
            Require all granted
            Satisfy any
        </If>
        <Else>
            AuthType Basic
            AuthName "GigHive Protected"
            AuthBasicProvider file
            AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
            Require valid-user
        </Else>
    </Location>

    # Request-time staging-only public access for /audio
    <LocationMatch "^/audio(?:/|$)">
        <If "%{HTTP_HOST} == 'staging.gighive.app'">
            Require all granted
            Satisfy any
        </If>
        <Else>
            AuthType Basic
            AuthName "GigHive Protected"
            AuthBasicProvider file
            AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
            Require valid-user
        </Else>
    </LocationMatch>

    # Request-time staging-only public access for /video
    <LocationMatch "^/video(?:/|$)">
        <If "%{HTTP_HOST} == 'staging.gighive.app'">
            Require all granted
            Satisfy any
        </If>
        <Else>
            AuthType Basic
            AuthName "GigHive Protected"
            AuthBasicProvider file
            AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
            Require valid-user
        </Else>
    </LocationMatch>

    # --- EXISTING PROTECTED AREAS (any valid user) ---
    # Excludes /db/health.php from authentication requirement
    <LocationMatch "^/(?:app/(?!cache(?:/|$)).*|api|db/(?!health\.php$).*|debug|src|vendor|video(?!/podcasts(?:/|$))|audio)(?:/|$)">
        AuthType Basic
        AuthName "GigHive Protected"
        AuthBasicProvider file
        AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
        Require valid-user
    </LocationMatch>

    # --- UPLOAD FORMS: admin + uploader ---
    <Location "/db/upload_form.php">
        AuthType Basic
        AuthName "GigHive"
        AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
        Require user admin uploader
    </Location>

    # --- ADMIN UPLOAD FORM: admin only ---
    <Location "/db/upload_form_admin.php">
        AuthType Basic
        AuthName "GigHive Admin"
        AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
        Require user admin
    </Location>

    <Location "/db/restore_database.php">
        AuthType Basic
        AuthName "GigHive Admin"
        AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
        Require user admin
    </Location>

    <Location "/db/restore_database_status.php">
        AuthType Basic
        AuthName "GigHive Admin"
        AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
        Require user admin
    </Location>

    <Location "/db/delete_media_files.php">
        AuthType Basic
        AuthName "GigHive Admin"
        AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
        Require user admin
    </Location>

    # --- UPLOAD API: admin + uploader ---
    <Location "/api/uploads.php">
        AuthType Basic
        AuthName "GigHive"
        AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
        Require user admin uploader
    </Location>

    # --- UPLOADS API (MVC ROUTES): admin + uploader ---
    <LocationMatch "^/api/uploads(?:/|$)">
        AuthType Basic
        AuthName "GigHive"
        AuthBasicProvider file
        AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
        Require user admin uploader
    </LocationMatch>

    # --- MEDIA-FILES API: admin + uploader ---
    <Location "/api/media-files">
        AuthType Basic
        AuthName "GigHive"
        AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
        Require user admin uploader
    </Location>

    # --- TUS UPLOAD ENDPOINT: admin + uploader ---
    <LocationMatch "^/files(?:/|$)">
        AuthType Basic
        AuthName "GigHive"
        AuthBasicProvider file
        AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
        Require user admin uploader
    </LocationMatch>

    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
    ProxyPass "/files/" "http://{{ apache_container_name }}_tusd:8080{{ tusd_base_path | default('/files') }}/" nocanon
    ProxyPassReverse "/files/" "http://{{ apache_container_name }}_tusd:8080{{ tusd_base_path | default('/files') }}/"
    
    # --- ADMIN PAGE: admin only ---
    <Location "/admin.php">
        AuthType Basic
        AuthName "GigHive Admin"
        AuthBasicProvider file
        AuthUserFile {{ gighive_htpasswd_path | default('/etc/apache2/gighive.htpasswd') }}
        Require user admin
    </Location>

    # ------------------------------------------------------
    # Extra safety: never serve these sensitive files
    # ------------------------------------------------------
 
     <IfModule mod_mime.c>
         AddType video/mp2t .m2t .ts
     </IfModule>
 
     <IfModule mod_headers.c>
         <FilesMatch "\.(m2t|ts)$">
             Header set Content-Disposition "attachment"
             Header set X-Content-Type-Options "nosniff"
         </FilesMatch>
     </IfModule>
 
    <FilesMatch "^(composer\.(json|lock)|config\.php)$">
        Require all denied
    </FilesMatch>

    # Also block hidden/dotfiles (e.g., .htpasswd, .env) just in case
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>

    # ensure Authorization header reaches PHP-FPM/proxy_fcgi
    SetEnvIfNoCase Authorization "^(.*)" HTTP_AUTHORIZATION=$1
</VirtualHost>

